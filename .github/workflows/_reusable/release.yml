name: Release
on:
  push:
    tags: [ "v*.*.*" ]

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  packages: write

jobs:
  zk-verify:
    uses: ./.github/workflows/_reusable/zk-verify.yml

  build-mcp:
    needs: zk-verify
    uses: ./.github/workflows/_reusable/docker-build-push.yml
    with:
      image: ghcr.io/${{ github.repository }}/orchestration-mcp
      context: mcp-server
      dockerfile: mcp-server/Dockerfile
      tags: |
        ghcr.io/${{ github.repository }}/orchestration-mcp:${{ github.ref_name }}
        ghcr.io/${{ github.repository }}/orchestration-mcp:latest

  helm-validate:
    needs: build-mcp
    uses: ./.github/workflows/_reusable/helm-validate.yml
    with:
      chartPath: "helm/mcp-stack"

  deploy-worker:
    needs: helm-validate
    uses: ./.github/workflows/_reusable/deploy-worker.yml

  release-tarball:
    needs: [build-mcp, helm-validate, deploy-worker]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - name: Create tarball
        run: |
          mkdir -p dist
          tar --exclude='**/node_modules' --exclude='.git' --exclude='dist' -czf dist/zf_release_${GITHUB_REF_NAME}.tar.gz .
      - name: Publish release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.tar.gz
          generate_release_notes: true
