+name: PE Unified CI (v2)
+
+on:
+  pull_request:
+    branches: [ main ]
+  workflow_dispatch: {}
+
+permissions:
+  contents: write
+  id-token: write        # required for cosign keyless attestation
+
+jobs:
+
+  prepare-matrix:
+    runs-on: ubuntu-latest
+    outputs:
+      matrix: ${{ steps.m.outputs.matrix }}
+      target_index: ${{ steps.idx.outputs.idx }}
+    steps:
+      - uses: actions/checkout@v4
+      - uses: actions/setup-python@v5
+        with: { python-version: '3.11' }
+
+      - name: Generate vector spaces & skills
+        id: m
+        run: |
+          python3 scripts/prepare_vector_matrix.py \
+            --sot config/sot.json \
+            --out config/vector_spaces.json \
+            --skills agents/skills/skills.md
+          echo "matrix=$(cat config/vector_spaces.json | jq '{vector: .spaces}')" >> $GITHUB_OUTPUT
+
+      - name: Generate Target Index
+        id: idx
+        run: |
+          python3 scripts/generate_target_index.py
+          echo "idx=$(cat config/target_index.json)" >> $GITHUB_OUTPUT
+
+      - uses: actions/upload-artifact@v4
+        with:
+          name: target-index
+          path: config/target_index.json
+
+  live-plan:
+    runs-on: ubuntu-latest
+    needs: prepare-matrix
+    outputs:
+      vector_matrix: ${{ steps.plan.outputs.vector_matrix }}
+    steps:
+      - uses: actions/checkout@v4
+      - uses: actions/setup-node@v4
+        with: { node-version: 20 }
+      - run: npm install -g pnpm
+      - run: pnpm install
+
+      - name: Build Live Plan
+        id: plan
+        run: |
+          node scripts/build_live_plan.js
+          echo "vector_matrix=$(cat config/live_plan.json | jq '.vector_matrix')" >> $GITHUB_OUTPUT
+
+      - uses: actions/upload-artifact@v4
+        with:
+          name: live-plan
+          path: config/live_plan.json
+
+  vector-space-tests:
+    runs-on: ubuntu-latest
+    needs: live-plan
+    strategy:
+      fail-fast: false
+      matrix: ${{ fromJson(needs.live-plan.outputs.vector_matrix) }}
+    env:
+      VECTOR_SPACE: ${{ matrix.vector }}
+    steps:
+      - uses: actions/checkout@v4
+      - uses: actions/setup-node@v4
+        with: { node-version: 20 }
+      - run: npm install -g pnpm
+      - run: pnpm install
+      - run: pnpm test -- --run
+
+  schema-validate:
+    runs-on: ubuntu-latest
+    needs: prepare-matrix
+    steps:
+      - uses: actions/checkout@v4
+      - uses: actions/setup-node@v4
+        with: { node-version: 20 }
+      - run: npm install -g pnpm
+      - run: pnpm install
+      - name: Validate JSON Schemas
+        run: |
+          if [ -d schemas ]; then pnpm run schema:check; fi
+
+  cosine-gates:
+    runs-on: ubuntu-latest
+    needs: prepare-matrix
+    steps:
+      - uses: actions/checkout@v4
+      - uses: actions/setup-node@v4
+        with: { node-version: 20 }
+      - run: node -e "
+          const v=require('./config/vector_spaces.json');
+          const t=require('./config/target_index.json');
+          if(!v.centroids || !t.vector_spaces) throw 'missing data';
+        "
+
+  auto-repair-codemod:
+    runs-on: ubuntu-latest
+    needs: [prepare-matrix, vector-space-tests]
+    outputs:
+      patch_exists: ${{ steps.detect.outputs.patch_exists }}
+    steps:
+      - uses: actions/checkout@v4
+      - uses: actions/setup-node@v4
+        with: { node-version: 20 }
+      - run: npm install -g pnpm
+      - run: pnpm install
+
+      - name: Run codemod
+        run: |
+          mkdir -p auto-repair
+          node scripts/codemod.js || true
+          if git diff --quiet; then
+            echo "{}" > auto-repair/no_changes.json
+          else
+            git diff > auto-repair/auto_repair.patch
+          fi
+
+      - name: Detect patch presence
+        id: detect
+        run: |
+          if [ -f auto-repair/auto_repair.patch ]; then
+            echo "patch_exists=true" >> $GITHUB_OUTPUT
+          else
+            echo "patch_exists=false" >> $GITHUB_OUTPUT
+          fi
+
+      - uses: actions/upload-artifact@v4
+        with:
+          name: auto-repair
+          path: auto-repair
+
+  auto-repair-attest:
+    runs-on: ubuntu-latest
+    needs: auto-repair-codemod
+    permissions:
+      id-token: write
+      contents: write
+    steps:
+      - uses: actions/checkout@v4
+      - uses: sigstore/cosign-installer@v3.4.0
+
+      - name: Prepare attestation subject
+        run: |
+          mkdir -p attest
+          if ${{ needs.auto-repair-codemod.outputs.patch_exists }}; then
+            cp auto-repair/auto_repair.patch attest/subject.bin
+          else
+            echo '{"no_changes":true}' > attest/subject.bin
+          fi
+
+      - name: Create attestation
+        run: |
+          cosign sign-blob --yes \
+            --output-signature attest/auto-repair.sig \
+            --output-certificate attest/auto-repair.cert.pem \
+            attest/subject.bin > attest/auto-repair.att.json
+
+      - uses: actions/upload-artifact@v4
+        with:
+          name: auto-repair-attestation
+          path: attest
+
+  # ------------------------------
+  # OPTIONAL: Automatic branch protection using GH CLI
+  # Requires a repo-admin PAT stored as REPO_ADMIN_TOKEN
+  # ------------------------------
+  enforce-required-checks:
+    if: ${{ github.event_name == 'workflow_dispatch' }}
+    runs-on: ubuntu-latest
+    steps:
+      - uses: actions/checkout@v4
+      - name: Configure required checks
+        env:
+          GH_TOKEN: ${{ secrets.REPO_ADMIN_TOKEN }}
+        run: |
+          gh api \
+            repos/${{ github.repository }}/branches/main/protection \
+            --method PUT \
+            --input - << 'EOF'
+          {
+            "required_status_checks": {
+              "strict": true,
+              "contexts": [
+                "prepare-matrix",
+                "vector-space-tests",
+                "schema-validate",
+                "cosine-gates",
+                "auto-repair-codemod",
+                "auto-repair-attest"
+              ]
+            }
+          }
+EOF
